<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weihnachtsmann TSP Solver</title>

    <!-- Leaflet CSS -->
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""
    />

    <style>
        :root {
            --color-primary: #2d7e8f;
            --color-success: #32b8c6;
            --color-text: #1f2121;
            --color-bg: #fcfcf9;
            --color-border: #d5d5d5;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--color-bg);
            color: var(--color-text);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .card h2 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 18px;
            color: var(--color-primary);
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            font-weight: 500;
            margin-bottom: 5px;
            font-size: 14px;
        }

        select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }

        button {
            background: var(--color-primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
            width: 100%;
        }

        button:hover {
            background: #1f5560;
        }

        button:active {
            background: #1a4a51;
        }

        .results {
            background: #f0f9fa;
            border-left: 4px solid var(--color-success);
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            display: none;
        }

        .results.show {
            display: block;
        }

        .result-item {
            margin-bottom: 10px;
            font-size: 14px;
        }

        .result-label {
            font-weight: 600;
            color: var(--color-primary);
        }

        .route-list {
            background: white;
            border: 1px solid var(--color-border);
            padding: 12px;
            border-radius: 6px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 13px;
            margin-top: 10px;
        }

        .route-item {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }

        .route-item:last-child {
            border-bottom: none;
        }

        .algorithm-info {
            background: #e8f4f8;
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .export-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--color-border);
        }

        .export-btn {
            background: #27ae60;
            font-size: 12px;
            padding: 8px 16px;
            margin-right: 10px;
        }

        .export-btn:hover {
            background: #229954;
        }

        .copy-btn {
            background: #3498db;
            font-size: 12px;
            padding: 8px 16px;
        }

        .copy-btn:hover {
            background: #2980b9;
        }

        .info-box {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 13px;
        }

        /* Leaflet-Container responsiv machen */
        #map {
            width: 100%;
            height: 600px;
            border: 1px solid var(--color-border);
            border-radius: 6px;
        }

        @media (max-width: 768px) {
            #map {
                height: 400px;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>ðŸŽ… Weihnachtsmann Reiseplaner</h1>
    <p class="subtitle">Travelling Salesman Problem (TSP) - Nearest Neighbor Algorithmus</p>

    <div class="grid">
        <!-- Control Panel -->
        <div class="card">
            <h2>Steuerung</h2>

            <div class="algorithm-info">
                <strong>Nearest Neighbor Algorithmus:</strong><br>
                Startet in einer Stadt und wÃ¤hlt immer die nÃ¤chstgelegene unbesuchte Stadt. Es werden immer alle StÃ¤dte aus der Liste verwendet.
            </div>

            <div class="form-group">
                <label for="startCity">Startstadt wÃ¤hlen:</label>
                <select id="startCity">
                    <option value="">-- Automatisch --</option>
                </select>
            </div>

            <button onclick="solveTSP()">ðŸš€ Route berechnen</button>

            <div class="results" id="results">
                <div class="result-item">
                    <span class="result-label">Gesamtstrecke:</span>
                    <span id="totalDistance">0</span> km
                </div>
                <div class="result-item">
                    <span class="result-label">Anzahl StÃ¤dte:</span>
                    <span id="cityCount">0</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Durchschnitt/Stadt:</span>
                    <span id="avgDistance">0</span> km
                </div>
                <div class="export-section">
                    <button class="export-btn" onclick="exportRoute()">ðŸ“¥ Route exportieren</button>
                    <button class="copy-btn" onclick="copyRouteToClipboard()">ðŸ“‹ Route kopieren</button>
                </div>
            </div>

            <div class="info-box">
                <strong>ðŸ’¡ Tipp:</strong> Teste verschiedene StartstÃ¤dte fÃ¼r potentiell bessere Routen!
            </div>
        </div>

        <!-- Route List -->
        <div class="card">
            <h2>Besuchsroute</h2>
            <div class="route-list" id="routeList">
                <div class="route-item" style="color: #999;">Route erscheint nach Berechnung...</div>
            </div>
        </div>
    </div>

    <!-- Interaktive Karte -->
    <div class="card">
        <h2>Interaktive Deutschlandkarte mit Route</h2>
        <div id="map"></div>
    </div>
</div>

<!-- Leaflet JS -->
<script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
></script>

<script>
    // Deutsche StÃ¤dte >100k Einwohner OHNE RUHRGEBIET
    const cities = {
        'Berlin': { lat: 52.520, lon: 13.405 },
        'Hamburg': { lat: 53.551, lon: 9.993 },
        'MÃ¼nchen': { lat: 48.135, lon: 11.582 },
        'KÃ¶ln': { lat: 50.938, lon: 6.963 },
        'Frankfurt am Main': { lat: 50.110, lon: 8.682 },
        'Stuttgart': { lat: 48.775, lon: 9.182 },
        'Bremen': { lat: 53.075, lon: 8.807 },
        'Bremerhaven': { lat: 53.598, lon: 8.571 },
        'Dresden': { lat: 51.049, lon: 13.738 },
        'Leipzig': { lat: 51.340, lon: 12.360 },
        'Hannover': { lat: 52.375, lon: 9.736 },
        'NÃ¼rnberg': { lat: 49.453, lon: 11.077 },
        'Bielefeld': { lat: 52.032, lon: 8.535 },
        'Bonn': { lat: 50.735, lon: 7.098 },
        'Mannheim': { lat: 49.489, lon: 8.466 },
        'Karlsruhe': { lat: 49.009, lon: 8.404 },
        'MÃ¼nster': { lat: 51.963, lon: 7.628 },
        'Wiesbaden': { lat: 50.083, lon: 8.245 },
        'Augsburg': { lat: 48.369, lon: 10.891 },
        'Aachen': { lat: 50.776, lon: 6.084 },
        'Chemnitz': { lat: 50.829, lon: 12.921 },
        'Kiel': { lat: 54.323, lon: 10.131 },
        'Halle (Saale)': { lat: 51.484, lon: 11.986 },
        'Magdeburg': { lat: 52.124, lon: 11.627 },
        'Freiburg im Breisgau': { lat: 47.999, lon: 7.842 },
        'LÃ¼beck': { lat: 53.870, lon: 10.687 },
        'Erfurt': { lat: 50.985, lon: 11.030 },
        'Rostock': { lat: 54.082, lon: 12.095 },
        'Mainz': { lat: 50.002, lon: 8.271 },
        'Kassel': { lat: 51.315, lon: 9.495 },
        'SaarbrÃ¼cken': { lat: 49.242, lon: 6.993 },
        'Potsdam': { lat: 52.391, lon: 13.065 },
        'Ludwigshafen am Rhein': { lat: 49.535, lon: 8.449 },
        'OsnabrÃ¼ck': { lat: 52.274, lon: 8.054 },
        'Oldenburg': { lat: 53.144, lon: 8.215 },
        'Heidelberg': { lat: 49.412, lon: 8.710 },
        'Darmstadt': { lat: 49.871, lon: 8.651 },
        'Reutlingen': { lat: 48.490, lon: 9.216 },
        'Pforzheim': { lat: 48.891, lon: 8.703 },
        'FÃ¼rth': { lat: 49.477, lon: 10.988 },
        'WÃ¼rzburg': { lat: 49.792, lon: 9.934 },
        'Erlangen': { lat: 49.597, lon: 11.005 },
        'Ingolstadt': { lat: 48.763, lon: 11.433 },
        'Ulm': { lat: 48.398, lon: 9.993 },
        'Wolfsburg': { lat: 52.422, lon: 10.787 },
        'Offenbach am Main': { lat: 50.094, lon: 8.766 },
        'Hamm': { lat: 51.856, lon: 7.819 },
        'Regensburg': { lat: 48.999, lon: 12.095 },
        'Heilbronn': { lat: 49.140, lon: 9.220 },
        'Ludwigsburg': { lat: 48.897, lon: 9.191 },
        'Esslingen am Neckar': { lat: 48.735, lon: 9.305 },
        'GÃ¶ttingen': { lat: 51.534, lon: 9.935 },
        'Salzgitter': { lat: 52.154, lon: 10.415 },
        'Schwerin': { lat: 53.629, lon: 11.414 },
        'Jena': { lat: 50.927, lon: 11.586 },
        'Siegen': { lat: 50.884, lon: 8.024 },
        'Kaiserslautern': { lat: 49.445, lon: 7.769 },
        'Trier': { lat: 49.749, lon: 6.637 },
        'Koblenz': { lat: 50.360, lon: 7.598 },
        'Leverkusen': { lat: 51.045, lon: 6.984 },
        'Paderborn': { lat: 51.719, lon: 8.755 },
        'Zwickau': { lat: 50.718, lon: 12.495 },
        'Gera': { lat: 50.878, lon: 12.083 }
    };

    let currentResult = null;
    let currentCityNames = [];

    // Distanz berechnen (vereinfacht)
    function calculateDistance(lat1, lon1, lat2, lon2) {
        const dlat = (lat2 - lat1) * 111;
        const dlon = (lon2 - lon1) * 70 * Math.cos(((lat1 + lat2) / 2) * Math.PI / 180);
        return Math.sqrt(dlat * dlat + dlon * dlon);
    }

    // Nearest Neighbor Algorithmus
    function nearestNeighbor(cityNames, startIndex) {
        const unvisited = new Set(cityNames.map((_, i) => i));
        const path = [startIndex];
        unvisited.delete(startIndex);

        let current = startIndex;
        let totalDist = 0;

        while (unvisited.size > 0) {
            let nearest = -1;
            let minDist = Infinity;

            for (let i of unvisited) {
                const dist = calculateDistance(
                    cities[cityNames[current]].lat,
                    cities[cityNames[current]].lon,
                    cities[cityNames[i]].lat,
                    cities[cityNames[i]].lon
                );
                if (dist < minDist) {
                    minDist = dist;
                    nearest = i;
                }
            }

            path.push(nearest);
            totalDist += minDist;
            unvisited.delete(nearest);
            current = nearest;
        }

        // KEINE RÃ¼ckkehr zum Start
        return { path, distance: totalDist };
    }

    // UI initialisieren
    function initUI() {
        const select = document.getElementById('startCity');
        const cityNames = Object.keys(cities);
        cityNames.forEach((city, idx) => {
            const option = document.createElement('option');
            option.value = idx;
            option.textContent = city;
            select.appendChild(option);
        });
    }

    // Leaflet-Karte initialisieren
    let map;
    let cityMarkers = [];
    let routePolyline = null;

    function initMap() {
        // Deutschland grob zentrieren
        map = L.map('map').setView([51.2, 10.5], 6);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap-Mitwirkende'
        }).addTo(map);

        // Alle StÃ¤dte als Marker (ohne Route erstmal)
        const allCityNames = Object.keys(cities);
        const bounds = [];
        allCityNames.forEach(name => {
            const c = cities[name];
            const marker = L.circleMarker([c.lat, c.lon], {
                radius: 6,
                color: '#32b8c6',
                weight: 2,
                fillColor: '#32b8c6',
                fillOpacity: 0.9
            }).bindPopup(name);
            marker.addTo(map);
            cityMarkers.push(marker);
            bounds.push([c.lat, c.lon]);
        });

        if (bounds.length > 0) {
            map.fitBounds(bounds, { padding: [20, 20] });
        }
    }

    // Karte basierend auf aktueller Route aktualisieren
    function updateMapRoute() {
        if (!map || !currentResult || !currentCityNames.length) return;

        // Alte Route entfernen
        if (routePolyline) {
            map.removeLayer(routePolyline);
        }

        // Marker-Styling resetten
        cityMarkers.forEach(m => {
            m.setStyle({
                radius: 6,
                color: '#32b8c6',
                weight: 2,
                fillColor: '#32b8c6',
                fillOpacity: 0.9
            });
        });

        // Koordinaten der Route
        const latlngs = currentResult.path.map(idx => {
            const name = currentCityNames[idx];
            const c = cities[name];
            return [c.lat, c.lon];
        });

        // Polyline zeichnen
        routePolyline = L.polyline(latlngs, {
            color: '#ff6b6b',
            weight: 4
        }).addTo(map);

        // Startmarker hervorheben
        const startIdx = currentResult.path[0];
        const startCityName = currentCityNames[startIdx];
        const startCity = cities[startCityName];

        // Einen extra Kreis fÃ¼r Startstadt
        L.circleMarker([startCity.lat, startCity.lon], {
            radius: 8,
            color: '#ff6b6b',
            weight: 3,
            fillColor: '#ff6b6b',
            fillOpacity: 1
        }).addTo(map).bindPopup('Start: ' + startCityName).openPopup();

        // Karte auf Route zoomen
        map.fitBounds(routePolyline.getBounds(), { padding: [30, 30] });
    }

    // TSP lÃ¶sen
    function solveTSP() {
        const allCityNames = Object.keys(cities);
        currentCityNames = allCityNames.slice(); // komplette Liste

        const startSelect = document.getElementById('startCity');
        let startIdx = parseInt(startSelect.value);

        if (isNaN(startIdx) || startIdx >= currentCityNames.length) {
            startIdx = 0;
            startSelect.value = 0;
        }

        currentResult = nearestNeighbor(currentCityNames, startIdx);
        const distance = Math.round(currentResult.distance * 100) / 100;

        document.getElementById('totalDistance').textContent = distance.toLocaleString('de-DE');
        document.getElementById('cityCount').textContent = currentCityNames.length;
        document.getElementById('avgDistance').textContent =
            (Math.round(distance / currentCityNames.length * 100) / 100).toLocaleString('de-DE');

        const routeList = document.getElementById('routeList');
        routeList.innerHTML = '';
        currentResult.path.forEach((idx, step) => {
            const city = currentCityNames[idx];
            const div = document.createElement('div');
            div.className = 'route-item';
            div.textContent = `${step + 1}. ${city}`;
            routeList.appendChild(div);
        });

        document.getElementById('results').classList.add('show');

        // Leaflet-Route aktualisieren
        updateMapRoute();
    }

    // Route exportieren
    function exportRoute() {
        if (!currentResult) return;
        let csv = 'Schritt,Stadt,Breite,LÃ¤nge\n';
        currentResult.path.forEach((idx, step) => {
            const name = currentCityNames[idx];
            const c = cities[name];
            csv += `${step + 1},${name},${c.lat},${c.lon}\n`;
        });

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'weihnachtsmann_route.csv';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    }

    // Route in Zwischenablage kopieren
    function copyRouteToClipboard() {
        if (!currentResult) return;
        let text = 'Weihnachtsmann Route:\n';
        currentResult.path.forEach((idx, step) => {
            text += `${step + 1}. ${currentCityNames[idx]}\n`;
        });
        text += `\nGesamtstrecke: ${Math.round(currentResult.distance * 100) / 100} km`;

        navigator.clipboard.writeText(text).then(() => {
            alert('Route in Zwischenablage kopiert!');
        });
    }

    // Init
    initUI();
    initMap();
</script>
</body>
</html>
